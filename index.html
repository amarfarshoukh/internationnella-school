<!DOCTYPE html>
<html>
<head>
  <title>Internationnella - Quiz Evaluation</title>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #0b0b0b;
      color: #f0eaea;
      font-family: 'Dancing Script', cursive;
      padding: 40px;
      position: relative;
      z-index: 1;
      overflow-x: hidden;
      min-height: 100vh;
      box-sizing: border-box;
    }

    /* Gold wave top decoration */
    .top-decoration {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100px;
      pointer-events: none;
      background-repeat: no-repeat;
      background-position: center top;
      background-size: cover;
      opacity: 0.15;
      z-index: 0;
      background-image: url('data:image/svg+xml;utf8,<svg width="1200" height="100" viewBox="0 0 1200 100" xmlns="http://www.w3.org/2000/svg" fill="none"><path fill="url(%23goldGradient)" d="M0,100 C300,0 900,0 1200,100 L1200,0 L0,0 Z" /><defs><linearGradient id="goldGradient" x1="0" y1="0" x2="1" y2="0"><stop offset="0%%" stop-color="%23bfa054"/><stop offset="50%%" stop-color="%23ffd700"/><stop offset="100%%" stop-color="%23bfa054"/></linearGradient></defs></svg>');
    }

    /* Gold wave bottom decoration */
    .bottom-decoration {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100px;
      pointer-events: none;
      background-repeat: no-repeat;
      background-position: center bottom;
      background-size: cover;
      opacity: 0.15;
      z-index: 0;
      background-image: url('data:image/svg+xml;utf8,<svg width="1200" height="100" viewBox="0 0 1200 100" xmlns="http://www.w3.org/2000/svg" fill="none"><path fill="url(%23goldGradient)" d="M0,0 C300,100 900,100 1200,0 L1200,100 L0,100 Z" /><defs><linearGradient id="goldGradient" x1="0" y1="0" x2="1" y2="0"><stop offset="0%%" stop-color="%23bfa054"/><stop offset="50%%" stop-color="%23ffd700"/><stop offset="100%%" stop-color="%23bfa054"/></linearGradient></defs></svg>');
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      position: relative;
      z-index: 1;
    }
    .header h1 {
      flex: 1;
      text-align: center;
      color: #800000;
      margin: 0;
      text-decoration: underline;
      text-underline-offset: 8px;
      text-decoration-thickness: 2px;
    }
    .header img {
      height: 120px;
      margin-left: 30px;
    }

    h2 {
      color: #800000;
      position: relative;
      z-index: 1;
    }

    /* Elegant Form Container */
    .form-box {
      background-color: #1a1a1a;
      border: 1.5px solid gold;
      border-radius: 15px;
      padding: 30px;
      margin-top: 30px;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
      position: relative;
      z-index: 1;
    }

    label {
      display: block;
      margin-top: 15px;
      font-size: 20px;
      color: #f0eaea;
    }

    input, select {
      padding: 12px;
      width: 100%;
      margin-top: 8px;
      font-family: 'Dancing Script', cursive;
      font-size: 18px;
      background-color: #0b0b0b;
      color: #f0eaea;
      border: 1px solid #444;
      border-radius: 10px;
      box-shadow: inset 0 0 4px rgba(255, 255, 255, 0.1);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    input:focus, select:focus {
      border-color: gold;
      outline: none;
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
    }

    button {
      background-color: gold;
      color: #0b0b0b;
      border: none;
      padding: 12px 25px;
      margin-top: 25px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      border-radius: 10px;
      font-family: 'Dancing Script', cursive;
      box-shadow: 0 0 12px rgba(255, 215, 0, 0.4);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    button:hover {
      background-color: #ffd700;
      box-shadow: 0 0 18px rgba(255, 215, 0, 0.6);
    }

    #result-box {
      margin-top: 30px;
      padding: 20px;
      border-left: 5px solid #800000;
      transition: background-color 0.5s ease;
      min-height: 60px;
      border-radius: 10px;
      background-color: #1a1a1a;
      position: relative;
      z-index: 1;
      white-space: pre-line;
    }

    footer {
      margin-top: 60px;
      display: flex;
      align-items: center;
      color: #ccc;
      position: relative;
      z-index: 1;
    }

    footer img {
      height: 70px;
      margin-right: 20px;
    }

    footer div {
      font-size: 14px;
      line-height: 1.5;
    }
    #recommendation {
  font-size: 26px;
  font-weight: bold;
  text-align: center;
  color: gold;
  text-shadow: 1px 1px 4px #800000;
  margin-top: 10px;
}
#chatbot-toggle {
  position: fixed;
  bottom: 25px;
  right: 25px;
  background-color: gold;
  color: #0b0b0b;
  font-weight: bold;
  padding: 12px 16px;
  border-radius: 50px;
  box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
  cursor: pointer;
  z-index: 999;
}

#chatbot-container {
  display: none;
  position: fixed;
  bottom: 80px;
  right: 25px;
  width: 360px;
  height: 500px;
  background-color: #1a1a1a;
  border: 2px solid gold;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
  z-index: 999;
  overflow: hidden;
  font-family: 'Dancing Script', cursive;
}

/* --- Fixed Header (No Cut-off) --- */
#chatbot-header {
  background-color: gold;
  color: #0b0b0b;
  padding: 16px;
  text-align: center;
  font-weight: bold;
  font-size: 22px;
  border-bottom: 2px solid #0b0b0b;
  white-space: nowrap; /* Prevents text wrapping */
  overflow: hidden;
  text-overflow: ellipsis; /* Adds "..." if text overflows */
}

/* --- Scrollable Messages (No Layout Shift) --- */
#chatbot-messages {
      height: calc(100% - 130px);
      overflow-y: auto;
      padding: 20px;
      color: #f0eaea;
      font-size: 18px;
      line-height: 1.6;
      scrollbar-width: thin;
      scrollbar-color: gold #1a1a1a;
    }
    
    /* Gold "You:" prefix */
    #chatbot-messages .user-message strong {
      color: gold;
    }
    
    /* Burgundy "Bot:" prefix */
    #chatbot-messages .bot-message strong {
      color: #800020;
    }
    
    /* Message container styling */
    #chatbot-messages .message {
      margin-bottom: 15px;
      padding: 8px 12px;
      border-radius: 8px;
      background-color: rgba(11, 11, 11, 0.7);
    }

/* Style message prefixes */
#chatbot-messages strong:contains("You:") {
  color: gold;
}

#chatbot-messages strong:contains("Bot:") {
  color: #800020; /* Burgundy color */
}

/* WebKit scrollbar styles */
#chatbot-messages::-webkit-scrollbar {
  width: 8px;
}

#chatbot-messages::-webkit-scrollbar-thumb {
  background-color: gold;
  border-radius: 4px;
}

#chatbot-messages::-webkit-scrollbar-track {
  background-color: #1a1a1a;
}

/* Input box styles remain unchanged */
#chatbot-input {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  width: calc(100% - 24px);
  margin: 12px;
  padding: 14px;
  border: 1px solid #444;
  border-radius: 6px;
  background-color: #1a1a1a;
  color: #f0eaea;
  font-size: 18px;
  outline: none;
}

#chatbot-input:focus {
  border-color: gold;
  box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
}


#chatbot-questions {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  padding: 10px;
  justify-content: center;
}

#chatbot-questions button {
  background-color: #a9002f;
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
  transition: background-color 0.3s;
}

#chatbot-questions button:hover {
  background-color: #6e0021;
}





  </style>

</head>
<body>
  
  <!-- Chatbot Toggle Button -->
  <div id="chatbot-toggle" onclick="toggleChatbot()">💬 Chat</div>

  <!-- Chatbot Container -->
  <div id="chatbot-container">
    <div id="chatbot-header">Internationnella Assistant 
      <span onclick="toggleChatbot()" style="cursor:pointer;">✖</span>
    </div>
    
    <div id="chatbot-messages">  
    </div>


      <!-- User input -->
      <input 
        type="text" 
        id="chatbot-input" 
        placeholder="Type your question..." 
        onkeypress="handleChatKey(event)">
    </div>
  </div>

  <!-- Top gold decoration -->
  <div class="top-decoration"></div>

  <!-- Header with logo -->
  <div class="header">
    <h1>Internationnella Quiz Results</h1>
    <img src="logo.png" alt="School Logo">
  </div>

  <!-- Elegant Form Box -->
  <form id="student-form">
    <div class="form-box">
      <label for="student-id">Student ID:</label>
      <input type="number" id="student-id" required>

      <label for="date">Date:</label>
      <input type="date" id="date" required>

      <label for="city">City:</label>
      <input type="text" id="city" required>

      <label for="grade">Grade (out of 20):</label>
      <input type="number" id="grade" min="0" max="20" step="0.1" required>

      <button type="submit">Evaluate</button>
    </div>
  </form>

  <!-- Result Box -->
  <div id="result-box">
    <h2>Evaluation:</h2>
    <p id="recommendation">Fill in the form to see your result.</p>
    <p id="analysis-box" style="display:none; margin-top: 1em; font-style: italic; font-size: 25px;"></p>
  </div>

  <!-- Footer -->
  <footer>
    <img src="logo.png" alt="School Logo Small">
    <div>
      <strong>Internationnella School</strong><br>
      Beirut, Lebanon<br>
      +961 xxx xxx xx
    </div>
  </footer>

  <!-- Bottom gold decoration -->
  <div class="bottom-decoration"></div>

  <script>
  // --- Student analysis logic remains unchanged ---
  async function fetchStudentAnalysis(cntstuid) {
    const analysisBox = document.getElementById('analysis-box');
    analysisBox.textContent = "Loading analysis...";
    analysisBox.style.display = 'block';

    try {
      console.log("Sending request for student:", cntstuid);
      const response = await fetch('http://localhost:5000/student_analysis', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ cntstuid: cntstuid })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || `Server returned ${response.status}`);
      }

      const data = await response.json();
      if (data.analysis) {
        analysisBox.textContent = data.analysis;
      } else if (data.error) {
        analysisBox.textContent = `⚠️ Backend Error: ${data.error}`;
      } else {
        analysisBox.textContent = "⚠️ Unexpected response from server";
      }
    } catch (error) {
      analysisBox.innerHTML = `
        ⚠️ Error: ${error.message}<br><br>
        <small>Check console for details and ensure:<br>
        - Flask server is running<br>
        - No CORS errors in Network tab</small>
      `;
    }
  }

  // --- Chatbot logic: STREAMING with /chatbot_stream ---
  function toggleChatbot() {
    const container = document.getElementById('chatbot-container');
    container.style.display = (container.style.display === 'none') ? 'block' : 'none';
  }

  // STREAMING function for chatbot
  let botMessageCount = 0;  // to create unique IDs

function sendMessage(message) {
  const messagesDiv = document.getElementById('chatbot-messages');

  // Add user message
  messagesDiv.innerHTML += `<div class="message user-message"><strong>You:</strong> ${message}</div>`;

  // Create a unique ID for the bot message
  botMessageCount++;
  const botTypingId = `bot-typing-${botMessageCount}`;

  // Create a new bot message container (no reuse)
  const botDiv = document.createElement("div");
  botDiv.className = "message bot-message";
  botDiv.innerHTML = `<strong>Bot:</strong> <span id="${botTypingId}"></span>`;
  messagesDiv.appendChild(botDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  const botTyping = document.getElementById(botTypingId);
  let botReply = "";

  fetch('http://localhost:5000/chatbot_stream', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message: message })
  })
  .then(response => {
    if (!response.body) throw new Error('No response body');
    const reader = response.body.getReader();
    const decoder = new TextDecoder();

    function readChunk() {
      return reader.read().then(({ done, value }) => {
        if (done) return;
        if (value) {
          const chunk = decoder.decode(value);
          botReply += chunk;
          botTyping.textContent = botReply;
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        return readChunk();
      });
    }
    return readChunk();
  })
  .catch(error => {
    botTyping.textContent = "⚠️ Error: " + error.message;
  });
}



  // Handle typing
  function handleChatKey(e) {
    if (e.key === 'Enter') {
      const input = document.getElementById('chatbot-input');
      const message = input.value.trim();
      if (message !== "") {
        sendMessage(message);
        input.value = '';
      }
    }
  }

  // Handle preset buttons
  function sendPreset(question) {
    document.getElementById('chatbot-input').value = question;
    sendMessage(question);
  }

  // Student form grade recommendation logic
  document.getElementById('student-form').addEventListener('submit', (e) => {
    e.preventDefault();

    const studentId = document.getElementById('student-id').value;
    const date = document.getElementById('date').value;
    const city = document.getElementById('city').value;
    const grade = parseFloat(document.getElementById('grade').value);

    let recommendation = '';
    let bgColor = '';

    if (grade < 10) {
      recommendation = "Don't be discouraged, there's room to improve. Keep Trying!";
      bgColor = '#5B0015';
    } else if (grade >= 10 && grade <= 16) {
      recommendation = "Not bad! You're doing okay, Keep Up the Steady Work.";
      bgColor = '#7C6B47';
    } else if (grade > 16 && grade < 19) {
      recommendation = "Great job! You're doing very well, Keep the Momentum!";
      bgColor = '#A9A9A9';
    } else if (grade >= 19 && grade <= 20) {
      recommendation = "Excellent work! You're at the top of your class, Well done!";
      bgColor = '#B8860B';
    } else {
      recommendation = "Invalid grade entered.";
      bgColor = '#444';
    }

    document.getElementById('recommendation').innerText =
      `Student ID ${studentId} from ${city}, evaluated on ${date}, scored ${grade}/20.\n${recommendation}`;
    document.getElementById('result-box').style.backgroundColor = bgColor;

    // Call backend analysis only if grade < 16
    if (grade < 16) {
      fetchStudentAnalysis(studentId);
    } else {
      // Hide analysis if grade >= 16
      const analysisBox = document.getElementById('analysis-box');
      if (analysisBox) analysisBox.style.display = 'none';
    }
  });

  // Attach chat input event
  document.getElementById('chatbot-input').addEventListener('keydown', handleChatKey);

  </script>
</body>
</html>